<!DOCTYPE html>
<html>
<head>
  <title>Keen IO Comprehensive Test</title>
  <link rel="stylesheet" href="keen-bootstrap.min.css">
  <link rel="stylesheet" href="keen-dashboards.css">
</head>
<body>
  <div class="container">

    <div class="page-header">
      <h1>Keen.Dataviz Visual Tests</h1>
    </div>
<pre class="pre-scrollable">
var client = new Keen({
  projectId: "your_project_id",
  readKey: "your_read_key"
});</pre>

    <div class="row">
      <div class="col-sm-4">
        <h2>[client].draw(q)</h2>
      </div>
      <div class="col-sm-4">
        <h2>[dataviz].parseRequest()</h2>
      </div>
      <div class="col-sm-4">
        <h2>[dataviz].parseRawData()</h2>
      </div>
    </div>
    <hr>


    <h3>Metric</h3>
<pre class="pre-scrollable">
var metric = new Keen.Query("count", {
  eventCollection: "pageview"
});
</pre><br>

    <div class="row">
      <div class="col-sm-4">
        <div id="1-1">A</div><br>
<pre class="pre-scrollable">
var m1 = document.getElementById("1-1");
var cfg = {
  colors: ["#f35757"],
  height: 138,
  title: "Total Pageviews"
};
var metric = client.draw(metric, m1, cfg);
</pre>
      </div>
      <div class="col-sm-4">
        <div id="1-2"></div><br>
<pre class="pre-scrollable">
var m2 = document.getElementById("1-2");
var req_metric = new Keen.Dataviz()
  .height(138)
  .colors(["#f0ad4e"])
  .el(m2)
  .prepare();

client.run(metric, function(){
  req_metric
    .parseRequest(this)
    .render();
});
</pre>
      </div>
      <div class="col-sm-4">
        <div id="1-3"></div><br>
<pre class="pre-scrollable">
var m3 = document.getElementById("1-3");
var req_metric = new Keen.Dataviz()
  .height(138)
  .colors(["#8383c6"])
  .el(m3)
  .prepare();

client.run(metric, function(err, res){
  req_metric
    .parseRawData(res)
    .render();
});
</pre>
      </div>
    </div>
    <hr>


    <h3>Categorical</h3>
<pre class="pre-scrollable">
var groupBy = new Keen.Query("count", {
  eventCollection: "pageview",
  groupBy: "page"
});
</pre><br>
    <h4>Pie chart</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="2-1"></div>
      </div>
      <div class="col-sm-4">
        <div id="2-2"></div>
      </div>
      <div class="col-sm-4">
        <div id="2-3"></div>
      </div>
    </div>
    <hr>

    <h3>Interval</h3>
<pre class="pre-scrollable">
var interval = new Keen.Query("count", {
  eventCollection: "pageview",
  timeframe: "this_12_months",
  interval: "monthly"
});
</pre>
    <h4>Area chart</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="3-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="3-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="3-3">C</div>
      </div>
    </div>
    <hr>

    <h4>Bar chart</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="4-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="4-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="4-3">C</div>
      </div>
    </div>

    <h4>Column chart</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="5-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="5-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="5-3">C</div>
      </div>
    </div>

    <h4>Line chart (single)</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="line-6-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="line-6-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="line-6-3">C</div>
      </div>
    </div>

    <h3>Categorical Interval</h3>
<pre class="pre-scrollable">
var multiline = new Keen.Query("count", {
  eventCollection: "pageview",
  groupBy: "page",
  timeframe: "this_12_months",
  interval: "monthly"
});
</pre>

    <h4>Line chart (multi)</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="multi-7-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="multi-7-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="multi-7-3">C</div>
      </div>
    </div>

    <h4 id="table">Table</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="chart-8-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="chart-8-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="chart-8-3">C</div>
      </div>
    </div>

    <h4>Extractions</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="9-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="9-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="9-3">C</div>
      </div>
    </div>

    <h4>Select Unique</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="su-10-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="su-10-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="su-10-3">C</div>
      </div>
    </div>

    <h4>Funnels</h4>
    <div class="row">
      <div class="col-sm-4">
        <div id="fun-1">A</div>
      </div>
      <div class="col-sm-4">
        <div id="fun-2">B</div>
      </div>
      <div class="col-sm-4">
        <div id="fun-3">C</div>
      </div>
    </div>

    <br/>
    <br/>
    <br/>
    <br/> <!-- Live life on the edge, yeah! -->

  </div>

  <script src="../../dist/keen.js"></script>
  <script>

    window.client = new Keen({
      projectId: "52f2ae5905cd661a7800000a",
      readKey: "4e4d72e5bf8b69686ed87a5a9671bba7ad829fbd10a1c281ee51b6e9c1ce9548e941e1f336f9de9281a5acc66ca8fdabc9b3c806e390eca01665f6a308a9b03d8b332b3fbd9f3cdfc3b3e16b0da6d84851e53fe20fbbce300801b8a401a6395b9f4ab9c89bff566e9678a74ca6624f9b",
      requestType: "jsonp"
    });

    Keen.ready(function() {

      // Keen.Dataviz.defaults.orderBy = "timeframe.end";
      // Keen.Visualization.defaults.orderBy = "timeframe.end";

      var metric = new Keen.Query("count", {
        eventCollection: "pageviews"
      });

      var groupBy = new Keen.Query("count", {
        event_collection: 'pageviews',
        group_by: 'user.device_info.browser.family'
      });

      var interval = new Keen.Query("count", {
        event_collection: 'pageviews',
        group_by: 'user.device_info.browser.family',
        timeframe: 'this_12_months',
        interval: 'weekly'
      });

      var multiline = new Keen.Query("count", {
        event_collection: 'pageviews',
        group_by: 'user.device_info.browser.family',
        timeframe: 'this_12_months',
        interval: 'weekly'
      });

      var extraction = new Keen.Query("extraction", {
        event_collection: "pageviews",
        latest: 100
        // propertyNames: ["keen.timestamp", "keen.id"]
      });

      var uniques = new Keen.Query("select_unique", {
        event_collection: "pageviews",
        targetProperty: "keen.id"
      });

      var funnel = new Keen.Query("funnel", {
        steps: [
          {
            eventCollection: "pageviews",
            actorProperty: "keen.id"
          },
          {
            eventCollection: "pageviews",
            actorProperty: "keen.id"
          },
          {
            eventCollection: "pageviews",
            actorProperty: "keen.id"
          }
        ]
      })

      window.reqs = {
        metric: client.run(metric),
        groupBy: client.run(groupBy),
        interval: client.run(interval),
        multiline: client.run(multiline),
        extraction: client.run(extraction),
        uniques: client.run(uniques),
        funnel: client.run(funnel)
      };

      var alt = false;
      setInterval(function(){
        var str = alt ? 'user.device_info.browser.family' : 'user.geo_info.province';

        groupBy.set({ groupBy: str });
        window.reqs.groupBy.refresh();

        // interval.set({ groupBy: str });
        // window.reqs.interval.refresh();

        multiline.set({ groupBy: str });
        window.reqs.multiline.refresh();

        alt = !alt;
      }, 10 * 1000);

      // var generateRandomData = function(res) {
      //   var newData = res;
      //   for (var i = 0; i < res.result.length; i++) {
      //     for (var j = 0; j < res.result[i].value.length; j++) {
      //       newData.result[i].value[j].result = Math.floor(Math.random() * (500 - 100 + 1)) + 100;
      //     }
      //   }
      //   return newData;
      // }


      /*
       *  ------------------------------
       *  Metrics
       *  ------------------------------
       */

      var drawn_metric = client.draw(metric, document.getElementById("1-1"), {
        colors: ["#f35757"],
        height: 138,
        title: "Single Metric",
        chartOptions: {
          suffix: "/mo",
          prefix: "$"
        }
      });

      var req_metric = new Keen.Dataviz()
        .height(138)
        .colors([Keen.Dataviz.defaults.colors[2]])
        .el(document.getElementById("1-2"))
        .prepare();

      var raw_metric = new Keen.Dataviz()
        // .height(138)
        .colors([Keen.Dataviz.defaults.colors[3]])
        .chartOptions({ prettyNumber: false, prefix: "$" })
        .el(document.getElementById("1-3"))
        .prepare();

      window.reqs['metric'].on("complete", function(err, res){
        //this.draw(document.getElementById("1-1"), { height: 138 });
        req_metric.parseRequest(this).render();
        raw_metric.parseRawData({ result: 3123 }).render();
      });
      window.reqs['metric'].on("error", function(err, res){
        req_metric.error(res.message);
        raw_metric.error(res.message);
      });


      /*
       *  ------------------------------
       *  Pie Charts
       *  ------------------------------
       */

      var drawn_pie = client.draw(groupBy, document.getElementById("2-1"), {
        height: 300,
        labelMapping: {
          "null": "Direct",
          "file://localhost/Users/Larimer/dev/keen/sandbox/video.js%20plugin/index.html": "Home",
          "file://localhost/Users/Larimer/Downloads/gist3a84fb3288737047e173-05ee2560c1be278096416081960b98ff0104ea4d/index.html": "Gallery"
        },
        colorMapping: {
          "Direct": "#808080"
        },
        sortGroups: "desc"
      });

      var req_pie = new Keen.Dataviz()
        .height(300)
        .labelMapping({
          "null": "Direct",
          "file://localhost/Users/Larimer/dev/keen/sandbox/video.js%20plugin/index.html": "Home",
          "file://localhost/Users/Larimer/Downloads/gist3a84fb3288737047e173-05ee2560c1be278096416081960b98ff0104ea4d/index.html": "Gallery"
        })
        .colorMapping({ "Direct": "#808080" })
        .sortGroups("desc")
        .el(document.getElementById("2-2"))
        .prepare();

      var raw_pie = new Keen.Dataviz()
        .height(300)
        .labelMapping({ "null": "Direct" })
        .colorMapping({ "Direct": "#808080" })
        .el(document.getElementById("2-3"))
        .prepare();

      window.reqs['groupBy'].on("complete", function(err, res){
        req_pie
          .parseRequest(this)
          .sortGroups("desc")
          .render();
        raw_pie
          .parseRawData(res)
          .labelMapping({ "null": "DIR (raw)" })
          .colorMapping({ "DIR (raw)": "#000" })
          .sortGroups("desc")
          .render();
      });
      window.reqs['groupBy'].on("error", function(err, res){
        req_pie.error(res.message);
        raw_pie.error(res.message);
      });


      /*
       *  ------------------------------
       *  Area Charts
       *  ------------------------------
       */

      var drawn_area = client.draw(interval, document.getElementById("3-1"), {
        chartType: 'areachart',
        height: 300,
        stacked: true
      });

      var req_area = new Keen.Dataviz()
        .height(300)
        .chartType('areachart')
        //.orderBy("timeframe.end")
        .el(document.getElementById("3-2"))
        .stacked(true)
        .prepare();

      var raw_area = new Keen.Dataviz()
        .height(300)
        .chartType('areachart')
        .el(document.getElementById("3-3"))
        .chartOptions({ isStacked: false }) // default
        .prepare();

      window.reqs['interval'].on("complete", function(err, res){
        req_area.parseRequest(this).render();
        raw_area.parseRawData(res)
        .render()
        .call(function(){
          // var dt = this.view._artifacts['datatable'].clone();
          // var len = dt.getNumberOfRows();
          // dt.removeRow(len-1);
          // this.view._artifacts['googlechart'].draw(dt);
        });
      });


      /*
       *  ------------------------------
       *  Bar Charts
       *  ------------------------------
       */

      var drawn_bar = client.draw(interval, document.getElementById("4-1"), {
        chartType: "barchart",
        height: 300
      });

      var req_bar = new Keen.Dataviz()
        .height(300)
        .chartType("barchart")
        .el(document.getElementById("4-2"))
        .prepare();

      var raw_bar = new Keen.Dataviz()
        .height(300)
        .chartType("barchart")
        .el(document.getElementById("4-3"))
        .prepare();

      window.reqs['interval'].on("complete", function(err, res){
        req_bar.parseRequest(this).render();
        raw_bar.parseRawData(res).render();
      });


      /*
       *  ------------------------------
       *  Column Charts
       *  ------------------------------
       */

      var drawn_col = client.draw(interval, document.getElementById("5-1"), {
        chartType: "columnchart",
        height: 300
      });

      var req_col = new Keen.Dataviz()
        .height(300)
        .chartType("columnchart")
        .el(document.getElementById("5-2"))
        .prepare();

      var raw_col = new Keen.Dataviz()
        .height(300)
        .chartType("columnchart")
        .el(document.getElementById("5-3"))
        .prepare();

      window.reqs['interval'].on("complete", function(err, res){
        req_col.parseRequest(this).render();
        raw_col.parseRawData(res).render();
      });


      /*
       *  ------------------------------
       *  Line Charts
       *  ------------------------------
       */

      var drawn_line = client.draw(interval, document.getElementById("line-6-1"), {
        chartType: "linechart",
        height: 300
      });

      var req_line = new Keen.Dataviz()
        .height(300)
        .chartType("linechart")
        .el(document.getElementById("line-6-2"))
        .prepare();

      var raw_line = new Keen.Dataviz()
        .height(300)
        .chartType("linechart")
        .el(document.getElementById("line-6-3"))
        .prepare();

      window.reqs['interval'].on("complete", function(err, res){
        req_line.parseRequest(this).render();
        raw_line.parseRawData(res).render();
      });


      /*
       *  ------------------------------
       *  Multiline Charts
       *  ------------------------------
       */

      var drawn_mline = client.draw(multiline, document.getElementById("multi-7-1"), {
        chartType: "linechart",
        height: 300
      });

      var req_mline = new Keen.Dataviz()
        .height(300)
        .chartType("linechart")
        .labelMapping({ "null": "pink" })
        .el(document.getElementById("multi-7-2"))
        .prepare();

      var raw_mline = new Keen.Dataviz()
        .height(300)
        .chartType("linechart")
        .colorMapping({ "null": "pink" })
        .el(document.getElementById("multi-7-3"))
        .prepare();

      window.reqs['multiline'].on("complete", function(err, res){
        console.log('multiline query complete!', this);
        console.log(res.result[0].value[0]);
        req_mline.parseRequest(this).render();
        raw_mline.parseRawData(res).render();
        console.log(raw_mline.dataset.selectRow(0));
        console.log(raw_mline.dataset.selectRow(1));
      });


      /*
       *  ------------------------------
       *  Tables
       *  ------------------------------
       */

      var drawn_table = client.draw(multiline, document.getElementById("chart-8-1"), {
        chartType: "table",
        height: 300,
        labelMapping: {
          "null": "Direct",
          "file://localhost/Users/Larimer/dev/keen/sandbox/video.js%20plugin/index.html": "Home",
          "file://localhost/Users/Larimer/Downloads/gist3a84fb3288737047e173-05ee2560c1be278096416081960b98ff0104ea4d/index.html": "Gallery"
        },
        // sortIntervals: "asc",
        chartOptions: {
          sortColumn: 1,
          sortAscending: false
        }
      });

      var req_table = new Keen.Dataviz()
        .height(300)
        .labelMapping({
          "null": "Direct",
          "file://localhost/Users/Larimer/dev/keen/sandbox/video.js%20plugin/index.html": "Home",
          "file://localhost/Users/Larimer/Downloads/gist3a84fb3288737047e173-05ee2560c1be278096416081960b98ff0104ea4d/index.html": "Gallery"
        })
        .chartType("table")
        .el(document.getElementById("chart-8-2"))
        .prepare();

      var raw_table = new Keen.Dataviz()
        .height(300)
        .labelMapping({
          "null": "Direct",
          "file://localhost/Users/Larimer/dev/keen/sandbox/video.js%20plugin/index.html": "Home",
          "file://localhost/Users/Larimer/Downloads/gist3a84fb3288737047e173-05ee2560c1be278096416081960b98ff0104ea4d/index.html": "Gallery"
        })
        .chartType("table")
        .el(document.getElementById("chart-8-3"))
        .prepare();

      window.reqs['multiline'].on("complete", function(err, res){
        req_table.parseRequest(this).render();
        raw_table.parseRawData(res).render();
      });

      var drawn_ext = client.draw(extraction, document.getElementById("9-1"), { height: 300 });
      var req_ext = new Keen.Dataviz().height(300).chartType("table").el(document.getElementById("9-2")).prepare();
      var raw_ext = new Keen.Dataviz().height(300).chartType("table").el(document.getElementById("9-3")).prepare();
      window.reqs['extraction'].on("complete", function(err, res){
        req_ext.parseRequest(this).render();
        raw_ext.parseRawData(res).render();
      });




      /*
       *  ------------------------------
       *  Select Uniques
       *  ------------------------------
       */

      var drawn_unique = client.draw(uniques, document.getElementById("su-10-1"), {
        height: 300
      });
      var req_unique = new Keen.Dataviz().height(300).chartType("table").el(document.getElementById("su-10-2")).prepare();
      var raw_unique = new Keen.Dataviz().height(300).chartType("table").el(document.getElementById("su-10-3")).prepare();
      window.reqs['uniques'].on("complete", function(err, res){
        req_unique.parseRequest(this).render();
        raw_unique.parseRawData(res).render();
      });




      /*
       *  ------------------------------
       *  Funnel
       *  ------------------------------
       */

       var drawn_funnel = client.draw(funnel, document.getElementById('fun-1'), {
         height: 300,
         title: 'Drawn Funnel',
         labels: [ 'A', 'B', 'C' ]
       });

       var req_funnel = new Keen.Dataviz()
        .height(300)
        .chartType('barchart')
        .el(document.getElementById('fun-2'))
        .title('Requested Funnel Data')
        .prepare();

      var raw_funnel = new Keen.Dataviz()
        .height(300)
        .chartType('barchart')
        .el(document.getElementById('fun-3'))
        .title('Raw Funnel Data')
        .prepare();

      window.reqs['funnel'].on('complete', function(err, res){
        req_funnel.parseRequest(this).labels([ 'A', 'B', 'C' ]).render();
        raw_funnel.parseRawData(res).labels([ 'A', 'B', 'C' ]).render();
      });
    });
  </script>

</body>
</html>
